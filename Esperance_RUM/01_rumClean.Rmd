# Set Up
```{r libs, include = FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(chron)
library(lunar)
library(ggplot2)
```

```{r directories, echo = FALSE}
w.dir <- "/Users/23088313/Documents/git_repos/Analysis-Hamre-Bioeconomic" # set working directory
d.dir <- paste(w.dir, "Esperance_RUM/rumIgnore", sep='/') # set data directory
f.dir <- paste(w.dir, "Esperance_RUM/rumFunc", sep = '/') # set function directory
```

```{r fun, include = FALSE}
source(paste(f.dir, "cleaningFunc.R", sep = '/')) # source cleaning functions
```

# Data Prep
After downloading the data from arcCollector, you end up four individual .csv docs for each survey layer; 

  - Meta
  - Extractive Use 
  - Non-Extractive Use
  - Avidity

1. Read in documents, including `na = c("", " ")` to make all empty cells consistent

```{r  read data}
# meta <- read_csv("rumIgnore/200322_Meta.csv", na =c("", " ", "na", "NA", "-"))
# ex <- read_csv("rumIgnore/200322_Extractive.csv", na =c("", " ", "na", "NA", "-"))
# nex <- read_csv("rumIgnore/200322_NoNExtractive.csv", na =c("", " ", "na", "NA", "-"))
# avid <- read_csv("rumIgnore/200322_Avidity.csv", na =c("", " ", "na", "NA", "-"))
```

Do not expect any of your data sheets to have the same number of observations.

  - Meta data will contain one observation per person approached so wil include refusals.
  
  - Extractive and non-extractive use data will contain an observation per use which may
  be more than one per person therefore could have more observations than the meta data.
  Alternatively it may have less observations than the meta data if most people doing the survey are
  participating in the alternative use type (i.e. most people are doing extractive and few are doing
  non-extractive)
  
  - Avidity data will contain an observation per completed survey, so you would expect there to be
  less observations in the avidity data than the meta data as it does not include refusals. 

For each individual dataset: 
  2. Check no missing GlobalIDs in Meta or GUIDs in Use or Avidity data
  3. Give ID variables intuitive names
  5 Add activity type for Use surveys

```{r  data prep}
# table(is.na(meta$GlobalID)) # all false
# 
# meta %<>% # meta data
#   rename(mObjID = OBJECTID,
#          mGlobID = GlobalID,
#          mLong = x,
#          mLat = y) %>%
#   dplyr::select(-c(created_user, last_edited_user, last_edited_date, "GUID for meta"))
# 
# table(is.na(ex$exGUID)) # all false
# 
# ex %<>% # extractive data
#   rename(exObjID = OBJECTID,
#          exGlobID = GlobalID,
#          exLong = x,
#          exLat = y) %>%
#   dplyr::select(-c(Creator, EditDate, Editor, CreationDate)) %>%
#   mutate(exActivityType = "Extractive")
# 
# table(is.na(nex$nexGUID)) # all false
# 
# nex %<>% # non-extractive data
#   rename(nexObjID = OBJECTID,
#          nexGlobID = GlobalID,
#          nexLong = x,
#          nexLat = y) %>%
#   dplyr::select(-c(Creator, EditDate, Editor, CreationDate)) %>%
#   mutate(nexActivityType = "NonExtractive")
# 
# table(is.na(avid$aGUID)) # all false
# 
# avid <- avid %>% # avidity data
#   rename(aObjID = OBJECTID,
#          aGlobID = GlobalID) %>%
#   dplyr::select(-c(Creator, EditDate, Editor, CreationDate))
```

Join the four data sets, linking them by the Meta GlobalID (primary key) and GUID (foreign key) of the other data sheets (ie. every Meta GlobalID should match the GUID in the other data sheets). 

meta (GlobalID) -> ex/nex/avid GUID

Use a `full_join` to connect individual data sheets. Using a inner join will remove refusals which are needed for response rate calculations. 

```{r  join}
# dat1 <- full_join(meta, ex, by = c("mGlobID" = "exGUID"), keep = T) # joining meta to extractive
# dat2 <- full_join(dat1, nex, by = c("mGlobID" = "nexGUID"), keep = T) # joining non-extractive
# esp <- full_join(dat2, avid, by = c("mGlobID" = "aGUID"), keep = T) # joining avidity
# 
# write.csv(esp, 'rumIgnore/RAW_Esp.csv')  # full raw un-cleaned dataset

esp <- read_csv("rumIgnore/RAW_Esp.csv")
```

# Clean
## Rename
Rename questions to make them R friendly
```{r select and filter}
esp  <- esp %>% 
dplyr::rename(ID = "...1",
              PersonID = mObjID,
              Interviewer = "# Interviewer",
              Site = "# Site",
              Screen18 = "Screen: 18+",
              PrevInter = "Screen: Have you been surveyed in the last 2 weeks?", 
              Agreement = "Agreement to participate",
              Resident = "Are you/have you been a resident, got a holiday home here or been here over 3 months?",
              
              nDaysInArea = "If here for less than 3 months, how many DAYS will you be in the area in total on this trip?",
              BoatAccess = "While you are on your trip, do you have access to a motorised boat/jetski (private/rental)?",
              nBoatDays = "If YES, how many DAYS out of your trip will you be going out on a boat in total?",
              nShoreDays = "How many DAYS of your trip will you be doing coastal shore based activities in total?",

              nTimesLast12m = "Excluding this trip, how many times have you been to the area in the last 12 month?",
              Date = "created_date",
              exSiteType = "# Is this a boat based or shore based activity?",
              exRecall = "If RECALL, what date did they go fishing?",
              FishingType = "What type of fishing did you do?",
              BaitLure = "Did you use bait or lure?",
              exStart = "What time did you START fishing at this site?",
              exStop = "What time did you STOP fishing at this site?",
              MaxHook = "What was your maximum hook depth (m) at this site?",
              KeptUndam = "Number of fish kept undamaged at this site?",
              RelUndam = "How many fish did you release at this site?",
              nDP = "How many shark bite offs did you get at this site?",
              Species = "What species of fish did you keep?", 
              exWhyLeave = "Why did you leave this site?",
              exComments = "Comments.x",
              nexSiteType = "# Is this a boat-based or shore-based activity?",
              nexRecall = "If RECALL, what date did they participant do the activity?",
              Activity = "What activity did you do?",
              nexStart = "What time did you START the activity?",
              nexStop = "What time did you STOP the activity?",
              DiveMaxDepth = "If DIVING, what was your maximum depth (m)?",
              WhyChoose = "Why did you CHOOSE this site?",
              nexWhyLeave = "Why did you LEAVE this site?",
              nexTimes12m = "How many DAYS have you done this activity in the last 12 months?",
              nexYrs = "How many YEARS have you been doing this activity?",
              nexComments = "Comments.y",
              exTimes12m = "How many days have you fished in the last 12 months?",
              exYrs = "How many years have you been fishing for?",
              DiveCert = "Are you a scuba diver? If so, what is your certification?",
              nDives = "If SCUBA DIVER, how many dives have you done?",
              YrBorn = "What year were you born?",
              Postcode = "What is your postcode?",
              Accom = "If VISITOR, where are you staying?",
              Sex = "# Female or Male",
              nFemales = "# Number of females in party (excluding participant)",
              nMales = "# Number of males in party (excluding participant)",
              nGirls = "# Number of girls in party",
              nBoys = "# Number of boys in party",
              BoatLength = "# Boat Length (m)",
              BoatID = "# Boat number and/or name",
              aComments = "Comments",
              exDetract = "Did anything detract from the experience you had at this site?",
              nexDetract = "Did anything detract from your experience at this site?",
              Native = "Are you of Aboriginal or Torres Strait Islander origin?",
              TO = "Do you identify as a TO in this region?",
              exCustom = "If of Aboriginal or Torres Strait Islander origin, was this activity undertaken for a customary purpose?.x",
              nexCustom = "If of Aboriginal or Torres Strait Islander origin, was this activity undertaken for a customary purpose?.y")
```

## Temporal variables
  - The date column is automated so there should be no NA's unless the agreement is no. 
  - Adhere start and stop times for extractive and non-extractive activities into one column,
    there should only be blanks where agreement is no. 
  - Due to recall trips need to make a trip date column which may be different to survey date.
  - Any data out with field trip dates is a dummy/test survey
  
```{r temporal variables}
# Date (Date) and Year (num/fac)
esp <- esp %>%
  mutate(Date = parse_date_time(Date, c("mdY IMS p"))) %>%  # making POSIX
  mutate(Date = as.Date(as.character(
    as.Date(substr(Date, 1, 10), "%Y-%m-%d")))) %>% # extracting date
  mutate(numYear = as.numeric(substr(Date, 1, 4))) %>% # extracting year (numeric)
  mutate(facYear = as.factor(numYear))  # year (factor)

# TripDate (Date), TripMonth (chr), TripJulianDay (num), binRecall (fac)
esp <- esp %>%
  mutate(exRecall = parse_date_time(exRecall, c("mdY IMS p"))) %>% # making POSIX
  mutate(exRecall = as.Date(substr(exRecall, 1, 10), "%Y-%m-%d")) %>% # extracting date
  mutate(nexRecall = parse_date_time(nexRecall, c("mdY IMS p"))) %>% # making POSIX
  mutate(nexRecall = as.Date(substr(nexRecall, 1, 10), "%Y-%m-%d")) %>% # extracting date
  mutate(TripDate = as.Date(ifelse(!is.na(exRecall), as.character(as.Date(exRecall)),
                                   as.character(as.Date(nexRecall))))) %>% # adhere recalls
  mutate(TripDate = as.Date(ifelse(is.na(TripDate),as.character(as.Date(Date)),
                                       as.character(as.Date(TripDate))))) %>% # adhere date
  mutate(TripMonth = as.factor(format(TripDate,"%B"))) %>% # month (chr)
  mutate(TripJulianDay = as.numeric(julian(TripDate))) %>% # julian date (num)
  mutate(binRecall = as.factor(ifelse(TripDate==Date, 0, 1))) # binary recall (fac)
  
# Start (chr), Stop (chr), MedianTime (chr), decMedianTime (num), decDuration (num)
esp <- esp %>%
  mutate(Start = substr(as.character(ifelse(!is.na(exStart), as.character(exStart),
                                     as.character(nexStart))), 1, 5)) %>% # start time
  mutate(Start = sub("[.]", ":", Start)) %>%  # change every bit of punctuation to a colon
  mutate(Start = ifelse(str_length(sub(":.*", "", Start)) != 2, str_c("0", Start),Start)) %>% 
  # if str_length before colon !=2, add a zero to the start
  mutate(Start = ifelse(str_length(sub(".*:", "", Start)) != 2, str_c(Start, "0"), Start)) %>% # if str_length after colon !=2, add a zero to the end
  mutate(Start = ifelse(Start %in% c("011am0", "11:90"), "11:00", Start)) %>% 
  mutate(Stop = substr(as.character(ifelse(!is.na(exStop), as.character(exStop),
                                     as.character(nexStop))), 1, 5)) %>%  # stop time
  mutate(Start = sub("[.]", ":", Start)) %>% # change every bit of punctuation to a colon
  mutate(Stop = ifelse(str_length(sub(":.*", "", Stop)) != 2, str_c("0", Stop),
                         Stop)) %>% # if str_length before colon !=2, add a zero to the start
  mutate(Stop = ifelse(str_length(sub(".*:", "", Stop)) != 2, str_c(Stop, "0"),
                         Stop)) # if str_length after colon !=2, add a zero to the end

# Need to check that all times are 4 digit, 5 character, 24 hour format separated with colon
# eg. 07:30, 19:30 NOT 7:30, 7pm, 19.30
# unique(esp$Start)
# unique(esp$Stop)

esp <- esp %>%
  mutate(temp_Start = parse_date_time(Start, c("HM"))) %>% # making temp_start POSIX for calcs
  mutate(temp_Stop = parse_date_time(Stop, c("HM"))) %>% # making temp_stop POSIX for calcs
  rowwise() %>%
  mutate(MedianTime = substr(median(c(temp_Start, temp_Stop)), 12, 16)) %>% # median time (chr)
  ungroup() %>% 
  mutate(decMedianTime = as.numeric(round(hhmm2dec(MedianTime), 
                                          digits = 2))) %>% #decimal median time (num)
  mutate(decDuration = as.numeric(round(difftime(
    temp_Stop, temp_Start, units = "hours"), digits = 2))) # decimal duration of activity (num)

# FieldTrip (num)
# Trip 1: 2022-01-16 - 2022-01-25
# Trip 2: 2022-02-14 - 2022-03-01
esp <- esp %>%
  mutate(FieldTrip = as.factor(ifelse(Date %within% interval(
    ymd("2022-01-16"), ymd("2022-01-25")), "1",NA))) %>% # assigning dates to field trip 1
  mutate(FieldTrip = as.factor(ifelse(Date %within% interval(
    ymd("2022-02-14"), ymd("2022-02-28")), "2", FieldTrip))) %>%
  mutate(FieldTrip = as.factor(ifelse(Date %within% interval(
    ymd("2022-03-07"), ymd("2022-03-20")), "2", FieldTrip))) %>%
  dplyr::filter(!is.na(FieldTrip), Interviewer != "Dummy") # filtering out submissions out with field trip dates (dummys)
```

## IDs
  -TripNum: all activities on one boat launch (individual date) are collectively a trip, only       applicable is data from recalled trips was collected (if TripNum >1 then binRecall should        equal 1). TripNum is chronological. 
  -SiteNum: the chronological order a site was visited within one trip
  
  * Mutate Person ID to reflect that people with same boat ID should have the same associated person ID. 

```{r IDs}
# Need to fix boat ID so everything is just 2 letter and 3 numbers, anything with 1 in position 2 should be I, move in boat names into boat name column
# esp1 <- esp %>%
#   # dplyr::mutate(BoatID = ifelse(str_detect(BoatID, "[H, h]ire|[R,r]ental|M&H"), "Rental",
#   # BoatID)) %>%
#   mutate(BoatID = gsub("[ ]", "", BoatID)) %>%
#   mutate(BoatID = toupper(BoatID)) %>% 
#   # mutate(BoatID = ifelse(str_detect(BoatID, "^.*[a-zA-Z]{1}[0-9]{4}.*$") & 
#   #                          str_sub(BoatID, 2,2)=="1", str_sub(BoatID, 2,2) <-"CHANGE", BoatID))
#  mutate(BoatName = ifelse(str_detect(BoatID, "^.*[a-zA-Z]{1}[0-9]{4}.*$") & str_sub(BoatID,2,2)=="1", str_sub(BoatID, 2,2) <- "I", NA))
# 
# 
#   mutate(BoatName = ifelse(!str_detect(BoatID, "^.*[a-zA-Z]{2}[0-9]{3}.*$|^.*[0-9]{5}.*$"), BoatID, NA))
#   mutate(BoatID = ifelse(BoatID == "WETO", NA, BoatID)) %>% 
#   mutate(BoatID = ifelse(BoatID == "49621/PEGASUS", 49621, BoatID)) 
#   mutate(PersonID = ifelse(duplicated(BoatID), ))
#   
#   group_by(BoatID) %>% 
#   
#   tidyr::fill(PersonID) %>% # NOT WORKING - boat id is not empty so wont fill. Fill fills NAs but no person ID is NA
#   ungroup() 
# 
#    dplyr::group_by(BoatName) %>% 
#   dplyr::mutate(PersonID = ifelse(anyDuplicated(BoatName) & BoatName != "RENTAL" & !is.na(BoatName), min(PersonID), PersonID)) %>%
#   dplyr::ungroup() %>% 
#   dplyr::group_by(BoatID) %>%
#   dplyr::mutate(PersonID = ifelse(anyDuplicated(BoatID) & BoatID != "RENTAL" & !is.na(BoatID), min(PersonID), PersonID)) %>%
#   dplyr::ungroup()
# 
# Ning <- Ning %>%
#   dplyr::group_by(PersonID) %>%
#   dplyr::arrange(TripDate, StartTime) %>%
#   dplyr::mutate(TripNum = as.numeric(as.factor(TripDate))) %>%
#   dplyr::mutate(SiteNum = sequence(rle(TripNum)$lengths)) %>%
#   dplyr::arrange(Date, Time, PersonID) %>%
#   dplyr::ungroup()
# 
# table(esp1$BoatID)
# esp1[b, c("PersonID", "BoatID", "PrevInter")]

esp <- esp %>%
  group_by(PersonID) %>%
  arrange(Start) %>% 
  mutate(TripNum = as.numeric(as.factor(TripDate))) %>% # number trips done by same person across different days
  mutate(SiteNum = sequence(rle(TripNum)$lengths)) %>% # chronological order of which a participant has conducted uses in a single trip
  arrange(ID) %>%
  dplyr::ungroup()
```

## Meta cleaning
```{r meta}
esp <- esp %>% 
  mutate(nBoatDays = as.numeric(ifelse(nBoatDays %in% "All", nBoatDays, nBoatDays))) %>% 
  mutate(nShoreDays = as.numeric(ifelse(nShoreDays %in% "All", nDaysInArea, nShoreDays))) %>% 
  mutate_each_(funs(factor(.)), c("Interviewer", "Screen18", "PrevInter", "Agreement",
                                  "BoatAccess", "Resident", "facYear"))
```

## Use cleaning
```{r use surveys}
esp <- esp %>% 
  mutate(SiteType = as.factor(ifelse(!is.na(exSiteType), exSiteType, nexSiteType))) %>% 
  mutate(ActivityType = as.factor(ifelse(!is.na(exActivityType), exActivityType, nexActivityType))) %>% 
  mutate(WhyLeave = as.factor(ifelse(!is.na(exWhyLeave), exWhyLeave, nexWhyLeave))) %>% 
  mutate(Detract = as.factor(ifelse(!is.na(exDetract), exDetract, nexDetract))) %>% 
  mutate(UseLat = ifelse(!is.na(exLat), exLat, nexLat)) %>% 
  mutate(UseLong = ifelse(!is.na(exLong), exLong, nexLong)) %>% 
  mutate(Activity = as.factor(ifelse(ActivityType == "Extractive", "Fishing", Activity))) %>% 
  mutate(MaxHook = ifelse(FishingType %in% "Trolling", 0, MaxHook)) %>% 
  mutate_each_(funs(factor(.)), c("FishingType", "WhyChoose", "BaitLure", "Site")) %>% 
  mutate(Comments = paste(exComments, nexComments, aComments, sep = "|"))
```

### Catch data
```{r Catch data}
esp <- esp %>%
  mutate(CaughtUndam = as.numeric(RelUndam + KeptUndam)) %>% 
  mutate(nHooked = as.numeric(CaughtUndam + nDP)) %>% 
  mutate(binDP = ifelse(nDP > 0, "1","0")) %>% 
  mutate(binDP = as.factor(binDP)) %>% 
  mutate(perDP = ifelse(nHooked %in% "0", 0, as.numeric(round((nDP/nHooked)*100, 2)))) %>% 
  mutate(proDP = as.numeric(round(perDP/100, 2))) %>% 
  mutate(nUndamHr = as.numeric(round(CaughtUndam/decDuration, 2))) %>% 
  mutate(nDPHr = as.numeric(round(nDP/decDuration, 2))) %>% 
  mutate(nHookedHr = as.numeric(round(nHooked/decDuration, 2))) %>% 
  mutate(DPrateHr = as.numeric(round(nDPHr/nHookedHr, 2))) %>% 
  mutate(DPrateHr = ifelse(is.nan(DPrateHr), 0, DPrateHr))
```

### Species Caught
```{r Species}
# 
# # Species Caught
# # Mostly done, just some issues with general fish species e.g. bream - could actually be a bream but could also be a common name for a snapper or a emperor
# Ning <- Ning %>%
#   mutate(Emperors = ifelse(str_detect(Species, "blue lined|blue line|black snapper|spangled|Spangled|spango|Spango|Spangley|spangley|spangly|Grassy|red spot|Long nose|Long tongs|REd emp|Red emperor|Red lipped
#                                       |Blue lined emp|Blue lines emp|Emperors|Emporer|slang emperor"), 1, NA)) %>%
#   mutate(Cods_Trouts_Groupers = ifelse(str_detect(Species, "estuarine cod|Charlie|charlie|rock cod|rockcod|sweetlips|coral|Coral|honeycomb|Honeycomb|honey|Honey|rankin|Coronation|coronation|nanny|Chinaman|chinamen|chinaman
#                                                   |cod|Cod|Cud’s"), 1, NA)) %>%
#   mutate(Snappers = ifelse(str_detect(Species, "Rims on|Red throat|Flag|flags|Ruby|Goldband|goldband|Goldban|Gold band||Golden band|gold and|Mangrove|mangrove|Jack|jack|Red snapper|Spainish|Striped sea|stripey sera"), 1, NA)) %>%
#   mutate(Breams = ifelse(str_detect(Species, "Robinson's|seabream|Seabream|Pink bream|thredfin|threadfin"), 1, NA)) %>%
#   mutate(Perch = ifelse(str_detect(Species, "Pearl perch|Dhufish|dhufosh"), 1, NA)) %>%
#   mutate(Pelagic = ifelse(str_detect(Species, "black marlin|sailfish|Marlin|barracude|trevally|Trevally|trivali|trevallu|Cobia|Kobe|Obie|queenie|Queenie|queen|tuna|Yellowfin|mackerel|Mackerel|mackrel|Mackeral|mac,real|Mackey
#                                      |Mahi|bludger|Wahoo|Waco"), 1, NA)) %>%
#   mutate(Flatheads_Cobblers = ifelse(str_detect(Species, "Cobbler|Flathead|Flatty|catfish|Northern flathead|Sandbar flathead"), 1, NA)) %>%
#   mutate(Pigfish_Tuskfish_Parrotfish = ifelse(str_detect(Species, "blue bone|black spot|parrot|vine"), 1, NA)) %>%
#   mutate(Cephalopods_Crustaceans = ifelse(str_detect(Species, "Squid|squid|Squids|squids|Prawn|prawn|Prawns|prawns"), 1, NA)) %>%
#   mutate(Others = ifelse(str_detect(Species, "Blowfish|Blowly|northwest|Damsel|Leather jacket|Lizard fish|Shark|Whalers"), 1, NA)) %>%
#   relocate(Emperors, .after=Species) %>%
#   relocate(Snappers, .after=Emperors) %>%
#   relocate(Breams, .after=Snappers) %>%
#   relocate(Cods_Trouts_Groupers, .after=Breams) %>%
#   relocate(Perch, .after=Cods_Trouts_Groupers) %>%
#   relocate(Pelagic, .after=Perch) %>%
#   relocate(Flatheads_Cobblers, .after=Pelagic) %>%
#   relocate(Pigfish_Tuskfish_Parrotfish, .after=Flatheads_Cobblers) %>%
#   relocate(Cephalopods_Crustaceans, .after=Pigfish_Tuskfish_Parrotfish) %>%
#   relocate(Others, .after=Cephalopods_Crustaceans)
# 
# unique(esp$Species)
```


## Avidity and demographics cleaning
```{r avidity clean}
esp <- esp %>% 
  mutate(bin_exTimes12m = ifelse(between(exTimes12m, 0, 4), "0-4", NA)) %>% 
  mutate(bin_exTimes12m = ifelse(between(exTimes12m, 5, 9), "5-9", bin_exTimes12m)) %>%
  mutate(bin_exTimes12m = ifelse(between(exTimes12m, 10, 14), "10-14", bin_exTimes12m)) %>%
  mutate(bin_exTimes12m = ifelse(between(exTimes12m, 15, 19), "15-19", bin_exTimes12m)) %>%
  mutate(bin_exTimes12m = ifelse(between(exTimes12m, 20, 29), "20-29", bin_exTimes12m)) %>%
  mutate(bin_exTimes12m = ifelse(between(exTimes12m, 30, 39), "30-39", bin_exTimes12m)) %>%
  mutate(bin_exTimes12m = ifelse(between(exTimes12m, 40, 59), "40-59", bin_exTimes12m)) %>%
  mutate(bin_exTimes12m = ifelse(exTimes12m > 59, "60+", bin_exTimes12m)) 
# Age 
esp <- esp %>% 
  mutate(Age = 2021-YrBorn) %>% 
  mutate(binAge = ifelse(between(Age, 18, 25), "18-24", NA)) %>% 
  mutate(binAge = ifelse(between(Age, 25, 34), "25-34", binAge)) %>%
  mutate(binAge = ifelse(between(Age, 35, 44), "35-44", binAge)) %>%
  mutate(binAge = ifelse(between(Age, 45, 54), "45-54", binAge)) %>%
  mutate(binAge = ifelse(between(Age, 55, 64), "55-64", binAge)) %>%
  mutate(binAge = ifelse(between(Age, 65, 74), "65-74", binAge)) %>%
  mutate(binAge = ifelse(Age>74, "75+", binAge))

# Postcode
esp <- esp %>% 
  mutate(Postcode = as.factor(ifelse(Resident == "Yes", "6450", Postcode))) %>% 
  mutate(Postcode = as.factor(ifelse(Postcode ==" 0", NA, Postcode))) 

# Party
esp <- esp %>% 
  mutate(Sex = as.factor(Sex)) %>% 
  mutate(nFemales = ifelse(is.na(nFemales), 0, nFemales)) %>%
  mutate(nMales = ifelse(is.na(nMales), 0, nMales)) %>%
  mutate(nGirls = ifelse(is.na(nGirls), 0, nGirls)) %>%
  mutate(nBoys = ifelse(is.na(nBoys), 0, nBoys)) %>%
  mutate(nFemales = ifelse(Sex %in% "Female", nFemales + 1, nFemales)) %>%
  mutate(nMales = ifelse(Sex %in% "Male", nMales + 1, nMales)) %>% 
  mutate(nAdults = nFemales + nMales) %>% 
  mutate(nChild = nGirls + nBoys) %>% 
  mutate(PartySize = nAdults + nChild) %>% 
  mutate_each_(funs(factor(.)), c("Accom", "DiveCert"))
```

## Lunar Phase
```{r lunar phase}
esp <- esp %>%
  mutate(LunarPhase = as.factor(lunar.phase(Date, name = TRUE)))
```

```{r}
esp <- esp %>% 
  dplyr::select(
    ID, Date, numYear, facYear, Interviewer, FieldTrip, mLat, mLong, PersonID, Screen18,
         PrevInter, Agreement, binRecall, TripDate, TripMonth, TripJulianDay, TripNum, SiteNum,
         Site, SiteType, Resident, BoatAccess, nDaysInArea, nBoatDays, nShoreDays, nTimesLast12m,
         UseLat, UseLong, ActivityType, Activity, Start, Stop, MedianTime, decMedianTime,
         decDuration, FishingType, BaitLure, MaxHook, KeptUndam, RelUndam, nDP, CaughtUndam,
         nHooked, binDP, perDP, proDP, CaughtUndam, nHooked, nUndamHr, nDPHr, DPrateHr, Species,
         DiveMaxDepth, WhyChoose, WhyLeave, Detract, bin_exTimes12m, exYrs, nexTimes12m, nexYrs,
         DiveCert, nDives, binAge, Postcode, Accom, Sex, nFemales, nMales, nGirls, nBoys, nAdults,
         nChild, PartySize, BoatLength, BoatID, Comments, LunarPhase)
```

# Check point
```{r csv}
write.csv(esp, "rumIgnore/Esp_v1.csv", row.names = FALSE) # Fully cleaned data
```
