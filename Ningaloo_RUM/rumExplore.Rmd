#Setup
##Libraries
```{r libraries, include = FALSE}
library(tidyverse)
library(lubridate)
library(chron)
library(sp)
library(raster)
library(ggplot2)
library(leaflet)
library(rgeos)
library(rgdal)
library(sf)
library(RColorBrewer)
library(ggsn)
library(cowplot)
library(rcartocolor)
library(tmap)
library(ggspatial)
```
## Directories
```{r}
w.dir <- "/Users/23088313/Documents/git_repos/Analysis-Hamre-Bioeconomic"
d.dir <- paste(w.dir, "Ningaloo_RUM/rumIgnore", sep='/')
s.dir <- paste(w.dir, "spIgnore/gpkg", sep='/')
r.dir <- paste(w.dir, "spIgnore/raster", sep='/')
f.dir <- paste(w.dir, "Ningaloo_RUM/rumFunc", sep = '/')
rumPlots <- paste(w.dir, "Ningaloo_RUM/rumPlots", sep='/')
```
## Data reading
```{r read data and spatial files}
# Data
Ning <- readRDS(paste(d.dir, "Ning_v2.csv", sep='/'))

#Spatial Data
spNing <- Ning %>% 
  filter(!is.na(UseLat), !is.na(UseLong)) %>% 
  st_as_sf(coords = c("UseLong", "UseLat"), crs = 4283)

NWS <- st_read(paste(s.dir, "NWScoast.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
nmp1 <- st_read(paste(s.dir, "nmpConserve.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
nmp2 <- st_read(paste(s.dir, "nmpGeneralUse.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
nmp3 <- st_read(paste(s.dir, "nmpManage.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
nmp4 <- st_read(paste(s.dir, "nmpOutline.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
nmp5 <- st_read(paste(s.dir, "nmpRec.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
nmp6 <- st_read(paste(s.dir, "nmpSanc.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
nmp7 <- st_read(paste(s.dir, "nmpShoreFish.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
nmp8 <- st_read(paste(s.dir, "nmpSpPurposeBenthic.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
nmp9 <- st_read(paste(s.dir, "nmpSpPurposeShore.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
ncmp1 <- st_read(paste(s.dir, "ncmpSplit.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
ncmp2 <- st_read(paste(s.dir, "ncmpSZ.gpkg", sep = '/')) %>%
  st_transform(crs = 4283)
```

# Overview of recreational marine use {.tabset}
```{r ResponseRate, echo = FALSE}
Approached <- Ning %>%
  distinct(PersonID, .keep_all = TRUE)

nApproached <- nrow(Approached)
nNE <- length(which(Approached$Agreement == "NE"))
nPartcipants <- length(which(Approached$Agreement == "Yes"))
nRefusals <- length(which(Approached$Agreement == "No"))

RefusalRate <- (nRefusals/(nApproached - nNE))*100
ResponseRate <- (nPartcipants/(nApproached - nNE))*100

ResponseStats <- expand.grid(nApproached = nApproached, nNE=nNE, nRefusals = nRefusals, RefusalRate=RefusalRate, nPartcipants=nPartcipants, ResponseRate=ResponseRate)

ResponseStats
```
# Subsetting data
```{r DataPrep}
yes <- Ning %>% 
  filter(Agreement == "Yes") 
# Extractive data
exdat <- yes %>%
  dplyr::filter(Activity == "Fishing")

# Boat based extractive
bf <- yes %>% 
  dplyr::filter(SiteType == "Boat" & ActivityType %in% c("Extractive", "Both"))

# Non-extractive data
nexdat <- yes %>%
  dplyr::filter(Activity != "Fishing")

```


## Activity Type
Histogram showing data collected of extractive and non-extractive activities and thier spatial distribution.
```{r ActTyp}
 ActTyp <- ggplot(yes) +
   aes(x = reorder(ActivityType, desc(ActivityType))) +
   geom_bar(fill = "#8fcaca") +
   labs(x = "Activity Type", y = paste("Frequency (n = ", nrow(yes), ")", sep = "")) +
   geom_text(stat='count', aes(label=..count..), vjust = -0.5, size = 2.5)
 
 ActTyp
 ggsave(paste(rumPlots, "ActTyp.png", sep='/'), width = 8, height = 4)
 
 # nEx <- length(which(N$ActivityType == "Extractive")) + length(which(N$ActivityType == "Both"))
 # nEx
 
#### Spatial plot for all eactivities across whole study site
ActType <- ggplot() +
  geom_sf(data = NWS, lwd = 0.1) +
  geom_sf(data = spNing, aes(color = ActivityType), size = 0.5) +# colour for discrete, fill for continuous
  geom_sf(data = nmp1, lwd = 0.1, fill = NA) +
  geom_sf(data = nmp2, lwd = 0.1, fill = NA) +
  # geom_sf(data = nmp3) +
  # geom_sf(data = nmp4) +
  geom_sf(data = nmp5, lwd = 0.1, fill = NA) +
  geom_sf(data = nmp6, lwd = 0.1, fill = NA) +
  geom_sf(data = nmp8, lwd = 0.1, fill = NA) +
  geom_sf(data = nmp9, lwd = 0.1, fill = NA) +
  geom_sf(data = ncmp2, lwd = 0.1, fill = NA) +
  scale_color_brewer(palette = "YlGnBu") + # colour for discrete, fill for continuous
  scale_fill_manual(values=c("#cce2cb", "#97c1a9", "#81caca")) +
  # labs(caption = "Spatial distribution of marine recreational use") +
  # annotation_scale(location = "br", pad_y = unit(0.1, "cm"), height = unit(0.5, "mm"), text_cex = 0.3, bar_cols = c("grey", "white"), line_width = 0.1) +
    # annotation_north_arrow(location = "br", which_north = "true", 
    #     pad_x = unit(0.5, "cm"), pad_y = unit(1, "cm"),
    #     style = north_arrow_fancy_orienteering(line_width = 1, text_size = 3, line_col = "Grey",
    #                                            fill = c("white", "Grey"), text_col = "grey"),
    #     height = unit(0.5, "cm"), width = unit(0.5, "cm")) +
    guides(color = guide_legend(title.theme = element_text(size = 6.5, vjust = 5),
                        label.theme = element_text(size = 6.5))) +
  theme_void()

ActType
ggsave(paste(rumPlots, "ActType.png", sep='/'), width = 4, height = 6)

```

## Activities

Histogram showing of data collected across all activities captured and their spatila distribution.
```{r ActFreq, fig.dim = c(7, 7)}

ActFreq <- yes %>% 
  group_by(Activity) %>%   
  mutate(count_name_occurr = n()) %>% 
  ggplot(aes(y=reorder(Activity,count_name_occurr))) +
  geom_bar(stat="count", fill = "#8fcaca") +
  labs(x = paste("Activity (n = ", length(na.omit(unique(yes$Activity))), ")", sep=""), y = paste("Frequency (n = ", nrow(yes), ")", sep = "")) +
  geom_text(stat='count', aes(label=..count..), hjust = -0.5, size = 2.5)
  
ActFreq
ggsave(paste(rumPlots, "ActFreq.png", sep='/'), width = 8, height = 4)

#### Spatial plot for all activities across whole study site
spAct <- ggplot() +
  geom_sf(data = NWS, lwd = 0.1) +
  geom_sf(data = spNing, aes(color = Activity, shape = ActivityType), size = 1) + # colour for discrete, fill for continuous
  scale_color_brewer(palette = "Set3") + # colour for discrete, fill for continuous
  labs(caption = "Spatial distribution of marine recreational use") +
  annotation_scale(location = "br", pad_y = unit(0.1, "cm"), height = unit(0.5, "mm"), text_cex = 0.3, bar_cols = c("grey", "white"), line_width = 0.1) +
    annotation_north_arrow(location = "br", which_north = "true", 
        pad_x = unit(0.5, "cm"), pad_y = unit(1, "cm"),
        style = north_arrow_fancy_orienteering(line_width = 1, text_size = 3, line_col = "Grey",
                                               fill = c("white", "Grey"), text_col = "grey"),
        height = unit(0.5, "cm"), width = unit(0.5, "cm")) +
  theme(axis.text.x = element_text(angle = 90, size = 7),
        axis.text.y = element_text(size = 7),
        legend.key = element_rect(fill = "White", color = "White"),
        plot.caption = element_text(hjust = 0, size = 5),
        legend.title = element_text(size = 7, vjust = 1),
        legend.text = element_text(size = 7)) +
  theme_void()

spAct
ggsave(paste(rumPlots, "spAct.png", sep='/'), width = 4, height = 6)
```

## Site Type
```{r SiteType}
 SiteTyp <- ggplot(yes) +
   aes(x = SiteType) +
   geom_bar(fill = "#8fcaca") +
   labs(x = "Site Type", y = "Frequency") +
   geom_text(stat='count', aes(label=..count..), vjust = -0.5, size = 2.5)
 
 SiteTyp
 ggsave(paste(rumPlots, "SiteTyp.png", sep='/'), width = 8, height = 4)

 # a <- which(is.na(yes$SiteType))
 # yes[a,]
```

# Extractive Activities {.tabset}
## Fishing Type
Histogram showing data collected across all fishing types facetted by year. 
```{r FTyp}
FTyp <- exdat %>%
  group_by(FishingType) %>%
  mutate(count_name_occurr = n()) %>%
  filter(!is.na(FishingType), FishingType != "") %>%
  ggplot(
  aes(x=reorder(FishingType,-count_name_occurr), fill = SiteType)) + #reorder(col to reorder, by what var)
  geom_bar(stat='count', position = position_dodge2(reverse = TRUE)) +
    scale_fill_manual(labels = c("Boat", "Shore"), values = c("#81caca", "#97c1a9"), name = "Site Type") +
  # scale_color_manual(labels = c("2015", "2016", "2020", "2021"), values = c("palevioletred1","lightskyblue", "lightsalmon","lightgreen"), name = "Year") +
  labs(x = paste("Fishing Type (n = ", length(na.omit(unique(exdat$FishingType))), ")", sep=""), y = paste("Frequency (n = ", nrow(exdat), ")", sep = "")) +
  # facet_wrap(. ~ numYear) +
  geom_text(stat='count', aes(label=..count..), vjust = -0.5, size = 2.5)

FTyp

ggsave(paste(rumPlots, "FishingType.png", sep='/'), width = 8, height = 4)

```

## Fishing types relevant to depredation
```{r DPFTyp}
dpFT <- exdat %>%
  group_by(FishingType) %>%
  summarise(tHooked = sum(nHooked),
            tDP = sum(nDP),
            tperDP = tDP/tHooked*100)

dpFT <-dpFT %>% 
  filter(!is.na(FishingType), tDP > 0) %>% 
  mutate(tperDP = round(tperDP))

dpFT

pdpFT <- ggplot(dpFT) +
  aes(x = reorder(FishingType, desc(FishingType)), y = tperDP) +
  geom_col(fill = "#8fcaca") +
    labs(x = paste("Fishing Type (n = ", length(na.omit(unique(dpFT$FishingType))), ")", sep=""), 
         y = "Percentage depredation (%)") +
  geom_text(aes(label= paste(tperDP, "%", sep="")), vjust = -0.5, size = 2.5)

pdpFT
```

## Depredation data set
Given that the above plot shows what fishing types are applicable to fishing this will be subsetted from the bf (boat fishing) data set. 
```{r creating depredation data set}
dpdat <- bf %>% 
  dplyr::filter(FishingType %in% c("Trolling", "Demersal"))

saveRDS(dpdat, paste(d.dir, "dpdat_v1.csv", sep = "/"))
```

# Non-extractive
## Spatial distribution
Spatial plot showing the spatial distribution of non-extractive activities. 
```{r NonextractiveExplore}

snexdat <- st_as_sf(nexdat, coords = c("UseLong", "UseLat"), ## This wont worj if there are blanks in data set so  filtered
                  crs = 4283)

snexdat

spnex <- ggplot() +
  geom_sf(data = NWS, lwd = 0.1) +
  geom_sf(data = snexdat, aes(color = Activity), size = 1) + # colour for discrete, fill for continuous
  scale_color_brewer(palette = "Set3") + # colour for discrete, fill for continuous
  labs(caption = "Spatial distribution of non-extractive marine recreational use") +
  annotation_scale(location = "br", pad_y = unit(0.1, "cm"), height = unit(0.1, "cm"), text_cex = 0.5, bar_cols = c("grey", "white"), line_width = 0.1) +
    annotation_north_arrow(location = "br", which_north = "true", 
        pad_x = unit(0.5, "cm"), pad_y = unit(1, "cm"),
        style = north_arrow_fancy_orienteering(line_width = 1, text_size = 3, line_col = "Grey",
                                               fill = c("white", "Grey"), text_col = "grey"),
        height = unit(0.5, "cm"), width = unit(0.5, "cm")) +
  theme(axis.text.x = element_text(angle = 90, size = 7),
        axis.text.y = element_text(size = 7),
        legend.key = element_rect(fill = "White", color = "White"),
        plot.caption = element_text(hjust = 0, size = 5),
        legend.title = element_text(size = 7, vjust = 1),
        legend.text = element_text(size = 7))

spnex
ggsave(paste(rumPlots, "spnex.png", sep='/'), width = 4, height = 6)
```


